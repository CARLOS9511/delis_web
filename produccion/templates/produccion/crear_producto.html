{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Producto - DELIS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }
        
        .info-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 25px;
        }
        
        .auto-box {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 25px;
        }
        
        .price-preview {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            display: none;
        }
        
        .price-preview.show {
            display: block;
        }
        
        .price-preview h5 {
            color: #065f46;
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: 600;
        }
        
        .price-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 5px;
        }
        
        .price-info span:first-child {
            color: #666;
            font-weight: 500;
        }
        
        .price-info span:last-child {
            font-weight: bold;
            color: #10b981;
        }
        
        .card {
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            border: none;
            border-radius: 12px;
        }
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0 !important;
            padding: 1.25rem;
        }
        
        .form-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .form-control, .form-select {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px 15px;
            transition: all 0.3s;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .alert {
            border-radius: 8px;
            border: none;
            padding: 15px 20px;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        
        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }
        
        .required {
            color: #e74c3c;
            margin-left: 3px;
        }
        
        .codigo-preview {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            border: 2px dashed #667eea;
        }
        
        .codigo-preview strong {
            color: #667eea;
            font-size: 1.1rem;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="text-white">
                    <i class="fas fa-birthday-cake"></i> 
                    Crear Nuevo Producto
                </h2>
                <p class="text-white-50 mb-0">
                    Complete los datos para agregar un producto al inventario 
                    ({{ nombres_productos|length }} productos disponibles)
                </p>
            </div>
            <a href="{% url 'produccion:lista' %}" class="btn btn-outline-light">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
        </div>

        {% if messages %}
        <div class="mb-4">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                <i class="fas fa-{% if message.tags == 'success' %}check-circle{% else %}exclamation-circle{% endif %}"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <form method="post" id="productoForm">
            {% csrf_token %}
            
            <div class="row">
                <!-- Columna Principal -->
                <div class="col-lg-8">
                    <!-- Información General -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle"></i> Información del Producto
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="auto-box">
                                <p class="mb-2">
                                    <i class="fas fa-magic"></i> 
                                    <strong>Generación Automática:</strong>
                                </p>
                                <ul class="mb-0" style="font-size: 0.9rem;">
                                    <li><strong>Código:</strong> Se generará automáticamente como P{día}{mes}{año}-{nombre}</li>
                                    <li><strong>Código Producto:</strong> Se asignará según el día de la semana (1=Lunes, 2=Martes, ..., 7=Domingo)</li>
                                    <li><strong>Precios:</strong> Se asignarán automáticamente según el producto seleccionado</li>
                                </ul>
                            </div>

                            <div class="info-box">
                                <p class="mb-0">
                                    <i class="fas fa-lightbulb"></i> 
                                    <strong>Importante:</strong> Al seleccionar el nombre del producto, el precio se asignará automáticamente según la lista predefinida.
                                </p>
                            </div>

                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="nombre" class="form-label">
                                        Nombre del Producto <span class="required">*</span>
                                    </label>
                                    <select id="nombre" name="nombre" class="form-select" required>
                                        <option value="">Seleccione un producto</option>
                                        {% for value, label in nombres_productos %}
                                        <option value="{{ value }}">{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                    
                                    <!-- Vista previa del código -->
                                    <div class="codigo-preview" id="codigoPreview" style="display: none;">
                                        <small class="text-muted d-block mb-1">
                                            <i class="fas fa-barcode"></i> Código que se generará:
                                        </small>
                                        <strong id="codigoGenerado">-</strong>
                                        <br>
                                        <small class="text-muted mt-2 d-block">
                                            <i class="fas fa-hashtag"></i> Código Producto (Día de la semana): 
                                            <strong id="codigoProductoGenerado">-</strong>
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="categoria" class="form-label">Categoría</label>
                                    <select id="categoria" name="categoria" class="form-select" required>
                                        <option value="" disabled selected>Seleccione una categoría</option>
                                        {% for categoria in categorias %}
                                            <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="stock" class="form-label">Stock Inicial</label>
                                    <input 
                                        type="number" 
                                        id="stock" 
                                        name="stock" 
                                        class="form-control"
                                        value="0" 
                                        min="0"
                                    >
                                    <small class="text-muted">Cantidad disponible</small>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="stock_minimo" class="form-label">Stock Mínimo</label>
                                    <input 
                                        type="number" 
                                        id="stock_minimo" 
                                        name="stock_minimo" 
                                        class="form-control"
                                        value="5" 
                                        min="0"
                                    >
                                    <small class="text-muted">Alerta de stock bajo</small>
                                </div>
                            </div>

                            <!-- Vista Previa de Precios -->
                            <div class="price-preview" id="pricePreview">
                                <h5>
                                    <i class="fas fa-money-bill-wave"></i> Vista Previa de Precios
                                </h5>
                                <div class="price-info">
                                    <span>Precio de Compra:</span>
                                    <span id="precioCompra">Bs. 0.00</span>
                                </div>
                                <div class="price-info">
                                    <span>Precio de Venta:</span>
                                    <span id="precioVenta">Bs. 0.00</span>
                                </div>
                                <div class="price-info" style="background: #f0fdf4;">
                                    <span>Margen de Ganancia:</span>
                                    <span id="margen">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Columna Lateral - Resumen -->
                <div class="col-lg-4">
                    <div class="card shadow-sm sticky-top" style="top: 20px;">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-clipboard-check"></i> Resumen
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <h6 class="text-muted mb-3">Datos del Producto</h6>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Código:</span>
                                    <strong id="resumen-codigo" class="text-primary">Auto-generado</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Nombre:</span>
                                    <strong id="resumen-nombre">-</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Categoría:</span>
                                    <strong id="resumen-categoria">-</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Stock:</span>
                                    <strong id="resumen-stock">0</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Cód. Producto:</span>
                                    <strong id="resumen-codigo-producto" class="text-info">Auto</strong>
                                </div>
                            </div>

                            <hr>

                            <div class="mb-4">
                                <h6 class="text-muted mb-3">Información de Precios</h6>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Precio Compra:</span>
                                    <strong class="text-primary" id="resumen-compra">Bs. 0.00</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Precio Venta:</span>
                                    <strong class="text-success" id="resumen-venta">Bs. 0.00</strong>
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-save"></i> Crear Producto
                                </button>
                                <a href="{% url 'produccion:lista' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times"></i> Cancelar
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Diccionario de precios (debe coincidir con el modelo Python)
        const PRECIOS_PRODUCTOS = {
            'Blanca 20p': {compra: 140.00, venta: 140.00},
            'Blanca 10p': {compra: 100.00, venta: 100.00},
            'Jaleada 20p': {compra: 150.00, venta: 150.00},
            'Jaleada 10p': {compra: 105.00, venta: 105.00},
            'Moca 20p': {compra: 150.00, venta: 150.00},
            'Moca 10p': {compra: 105.00, venta: 105.00},
            'Selva Negra20p': {compra: 170.00, venta: 170.00},
            'Selva Negra 10p': {compra: 120.00, venta: 120.00},
            'Tres Leches 20p': {compra: 170.00, venta: 170.00},
            'Tres Leches 10p': {compra: 120.00, venta: 120.00},
            'Maracuya 20p': {compra: 170.00, venta: 170.00},
            'Maracuya 10p': {compra: 120.00, venta: 120.00},
            'Chocomoca 20p': {compra: 170.00, venta: 170.00},
            'Chocomoca 10p': {compra: 120.00, venta: 120.00},
            'Chocodelis 20p': {compra: 170.00, venta: 170.00},
            'Chocodelis 10p': {compra: 120.00, venta: 120.00},
            'Porcion de Frutas': {compra: 12.00, venta: 12.00},
            'Porcion Moca': {compra: 13.00, venta: 13.00},
            'Porcion Selva Negra': {compra: 14.00, venta: 14.00},
            'Porcion 3 Leches': {compra: 14.00, venta: 14.00},
            'Porcion Maracuya': {compra: 12.00, venta: 12.00},
            'Porcion chocomooka': {compra: 14.00, venta: 14.00},
            'Porcion Chocodelis': {compra: 14.00, venta: 14.00},
            'Alfafor': {compra: 7.00, venta: 7.00},
            'Copas': {compra: 15.00, venta: 15.00},
            'Chesecake vaso': {compra: 8.00, venta: 8.00},
            'Mouse Copa': {compra: 8.00, venta: 8.00},
            'Mouse entero': {compra: 50.00, venta: 50.00},
            'Mil hojas': {compra: 8.00, venta: 8.00},
            'Brownie Chocolate': {compra: 8.00, venta: 8.00},
            'Brownie  Quinua': {compra: 8.00, venta: 8.00},
            'Brownie Maracuya': {compra: 8.00, venta: 8.00},
            'Bomba': {compra: 7.00, venta: 7.00},
            'Brazo Gitano': {compra: 45.00, venta: 45.00},
            'Pie de manzana porc.': {compra: 9.00, venta: 9.00},
            'Pie de limon  porc.': {compra: 9.00, venta: 9.00},
            'Pie de piña porc.': {compra: 9.00, venta: 9.00},
            'Pie de frutas porc.': {compra: 9.00, venta: 9.00},
            'Pie de manzana ent.': {compra: 55.00, venta: 55.00},
            'Pie de limon ent.': {compra: 55.00, venta: 55.00},
            'Pie de piña  ent.': {compra: 55.00, venta: 55.00},
            'Pie de frutas ent.': {compra: 55.00, venta: 55.00},
            'Conitos': {compra: 8.00, venta: 8.00},
            'Cupcakes': {compra: 7.00, venta: 7.00},
            'Queque ': {compra: 20.00, venta: 20.00},
            'Muffy': {compra: 7.00, venta: 7.00},
            'Mini bomba': {compra: 5.00, venta: 5.00},
            'Rollo': {compra: 20.00, venta: 20.00},
            'Empanadas': {compra: 5.00, venta: 5.00},
            'Croisant': {compra: 8.00, venta: 8.00},
            'Pan Pizza': {compra: 8.00, venta: 8.00},
            'Blanca de 30p': {compra: 240.00, venta: 240.00},
        };

        // Nombres de los días de la semana
        const DIAS_SEMANA = {
            1: 'Lunes',
            2: 'Martes',
            3: 'Miércoles',
            4: 'Jueves',
            5: 'Viernes',
            6: 'Sábado',
            7: 'Domingo'
        };

        // Generar código preview
        function generarCodigoPreview(nombre) {
            const now = new Date();
            const dia = String(now.getDate()).padStart(2, '0');
            const mes = String(now.getMonth() + 1).padStart(2, '0');
            const anio = now.getFullYear();
            const nombreCorto = nombre.replace(/\s+/g, '').substring(0, 10);
            const codigo = `P${dia}${mes}${anio}-${nombreCorto}`;
            
            // Obtener día de la semana (1-7, donde 1 es Lunes)
            const diaSemana = now.getDay() === 0 ? 7 : now.getDay();
            const nombreDia = DIAS_SEMANA[diaSemana];
            
            return {
                codigo: codigo,
                codigoProducto: diaSemana,
                nombreDia: nombreDia
            };
        }

        // Actualizar vista previa de código
        function actualizarCodigoPreview() {
            const productoSeleccionado = document.getElementById('nombre').value;
            const codigoPreview = document.getElementById('codigoPreview');
            
            if (productoSeleccionado) {
                const preview = generarCodigoPreview(productoSeleccionado);
                document.getElementById('codigoGenerado').textContent = preview.codigo;
                document.getElementById('codigoProductoGenerado').textContent = 
                    `${preview.codigoProducto} (${preview.nombreDia})`;
                document.getElementById('resumen-codigo').textContent = preview.codigo;
                document.getElementById('resumen-codigo-producto').textContent = 
                    `${preview.codigoProducto} (${preview.nombreDia})`;
                codigoPreview.style.display = 'block';
            } else {
                codigoPreview.style.display = 'none';
                document.getElementById('resumen-codigo').textContent = 'Auto-generado';
                document.getElementById('resumen-codigo-producto').textContent = 'Auto';
            }
        }

        // Actualizar vista previa y resumen
        function actualizarPrecios() {
            const productoSeleccionado = document.getElementById('nombre').value;
            const pricePreview = document.getElementById('pricePreview');
            
            if (PRECIOS_PRODUCTOS[productoSeleccionado]) {
                const precios = PRECIOS_PRODUCTOS[productoSeleccionado];
                const margen = precios.compra > 0 ? (((precios.venta - precios.compra) / precios.compra) * 100).toFixed(2) : 0;
                
                // Actualizar vista previa
                document.getElementById('precioCompra').textContent = `Bs. ${precios.compra.toFixed(2)}`;
                document.getElementById('precioVenta').textContent = `Bs. ${precios.venta.toFixed(2)}`;
                document.getElementById('margen').textContent = `${margen}%`;
                pricePreview.classList.add('show');
                
                // Actualizar resumen
                document.getElementById('resumen-compra').textContent = `Bs. ${precios.compra.toFixed(2)}`;
                document.getElementById('resumen-venta').textContent = `Bs. ${precios.venta.toFixed(2)}`;
            } else {
                pricePreview.classList.remove('show');
            }
        }

        // Actualizar resumen en tiempo real
        function actualizarResumen() {
            const nombre = document.getElementById('nombre').options[document.getElementById('nombre').selectedIndex].text || '-';
            const categoria = document.getElementById('categoria').options[document.getElementById('categoria').selectedIndex].text || '-';
            const stock = document.getElementById('stock').value || '0';
            
            document.getElementById('resumen-nombre').textContent = nombre;
            document.getElementById('resumen-categoria').textContent = categoria;
            document.getElementById('resumen-stock').textContent = stock;
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('nombre').addEventListener('change', function() {
                actualizarCodigoPreview();
                actualizarPrecios();
                actualizarResumen();
            });
            
            document.getElementById('categoria').addEventListener('change', actualizarResumen);
            document.getElementById('stock').addEventListener('input', actualizarResumen);
        });

        // Validación del formulario
        document.getElementById('productoForm').addEventListener('submit', function(e) {
            const nombre = document.getElementById('nombre').value;
            
            if (!nombre) {
                e.preventDefault();
                alert('⚠️ Por favor seleccione un nombre de producto');
                return false;
            }
        });
    </script>
</body>
</html>