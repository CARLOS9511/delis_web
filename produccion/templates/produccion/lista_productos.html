<!-- produccion/templates/produccion/lista_productos.html -->
{% extends 'base.html' %}

{% block title %}Productos - Producci√≥n{% endblock %}

{% block page_title %}üì¶ Productos de Producci√≥n{% endblock %}

{% block extra_css %}
<style>
    .tabla-productos {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    }
    
    .tabla-productos table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .tabla-productos thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .tabla-productos thead th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .tabla-productos tbody tr {
        border-bottom: 1px solid #f1f5f9;
        transition: all 0.2s ease;
    }
    
    .tabla-productos tbody tr:hover {
        background: #f8fafc;
    }
    
    .tabla-productos tbody td {
        padding: 1rem;
        vertical-align: middle;
    }
    
    .producto-imagen-mini {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        overflow: hidden;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
    }
    
    .producto-imagen-mini img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .producto-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .producto-detalles h3 {
        font-size: 1rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 0.25rem;
    }
    
    .producto-codigo {
        font-size: 0.85rem;
        color: #64748b;
        font-family: monospace;
    }
    
    .badge {
        padding: 4px 12px;
        border-radius: 16px;
        font-size: 0.8rem;
        font-weight: 600;
        display: inline-block;
    }
    
    .badge-activo {
        background: #d1fae5;
        color: #065f46;
    }
    
    .badge-inactivo {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .stock-cell {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .stock-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }
    
    .dot-verde { background: #10b981; }
    .dot-amarillo { background: #f59e0b; }
    .dot-rojo { background: #ef4444; }
    
    .stock-valor {
        font-weight: 700;
        font-size: 1.1rem;
    }
    
    .stock-alto { color: #10b981; }
    .stock-medio { color: #f59e0b; }
    .stock-bajo { color: #ef4444; }
    
    .precio-cell {
        text-align: right;
        font-weight: 700;
    }
    
    .precio-compra { color: #f59e0b; }
    .precio-venta { color: #10b981; }
    .precio-ganancia { color: #667eea; }
    
    .acciones-cell {
        text-align: center;
    }
    
    .btn-tabla {
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-editar {
        background: #3b82f6;
        color: white;
    }
    
    .btn-editar:hover {
        background: #2563eb;
    }
    
    .btn-ver {
        background: #64748b;
        color: white;
    }
    
    .btn-ver:hover {
        background: #475569;
    }
    
    .filtros-container {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .stat-card {
        background: white;
        padding: 1.25rem;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border-left: 4px solid #667eea;
    }
    
    .stat-valor {
        font-size: 2rem;
        font-weight: 800;
        color: #1e293b;
        margin-bottom: 0.25rem;
    }
    
    .stat-label {
        font-size: 0.85rem;
        color: #64748b;
        font-weight: 500;
    }
    
    .tabla-vacia {
        text-align: center;
        padding: 4rem 2rem;
        color: #94a3b8;
    }
    
    .tabla-vacia-icon {
        font-size: 5rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    .ordenar-link {
        color: white;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .ordenar-link:hover {
        opacity: 0.8;
    }
    
    @media (max-width: 1024px) {
        .tabla-productos {
            overflow-x: auto;
        }
        
        .stats-row {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Encabezado -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">üì¶ Productos de Producci√≥n</h2>
        <div style="display: flex; gap: 1rem;">
            <a href="{% url 'produccion:crear' %}" class="btn btn-primary">
                ‚ûï Nuevo Producto
            </a>
            <a href="{% url 'produccion:importar_excel_view' %}" class="btn btn-success">
                üìä Importar desde Excel
            </a>
            <button class="btn btn-success" onclick="window.print()">
                üñ®Ô∏è Imprimir
            </button>
        </div>
    </div>
</div>

<!-- Estad√≠sticas -->
<div class="stats-row">
    <div class="stat-card" style="border-left-color: #3b82f6;">
        <div class="stat-valor">{{ total_productos }}</div>
        <div class="stat-label">üì¶ Total Productos</div>
    </div>
    <div class="stat-card" style="border-left-color: #10b981;">
        <div class="stat-valor" style="color: #10b981;">{{ productos_activos }}</div>
        <div class="stat-label">‚úÖ Productos Activos</div>
    </div>
    <div class="stat-card" style="border-left-color: #f59e0b;">
        <div class="stat-valor" style="color: #f59e0b;">{{ stock_total }}</div>
        <div class="stat-label">üìä Stock Total</div>
    </div>
    <div class="stat-card" style="border-left-color: #ef4444;">
        <div class="stat-valor" style="color: #ef4444;">{{ productos_stock_bajo }}</div>
        <div class="stat-label">‚ö†Ô∏è Stock Bajo</div>
    </div>
</div>

<!-- Filtros -->
<div class="filtros-container">
    <form method="GET">
        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 1rem; align-items: end;">
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151;">
                    üîç Buscar:
                </label>
                <input type="text" name="buscar" placeholder="Buscar por c√≥digo o nombre..." 
                       value="{{ request.GET.buscar }}"
                       style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
            </div>
            
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151;">
                    üóÇÔ∏è Categor√≠a:
                </label>
                <select name="categoria" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
                    <option value="">Todas</option>
                    {% for cat in categorias %}
                    <option value="{{ cat.id }}" {% if request.GET.categoria == cat.id|stringformat:"s" %}selected{% endif %}>
                        {{ cat.nombre }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151;">
                    üìä Estado:
                </label>
                <select name="estado" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
                    <option value="">Todos</option>
                    <option value="activo" {% if request.GET.estado == 'activo' %}selected{% endif %}>Activos</option>
                    <option value="inactivo" {% if request.GET.estado == 'inactivo' %}selected{% endif %}>Inactivos</option>
                    <option value="stock_bajo" {% if request.GET.estado == 'stock_bajo' %}selected{% endif %}>Stock Bajo</option>
                    <option value="sin_stock" {% if request.GET.estado == 'sin_stock' %}selected{% endif %}>Sin Stock</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 0.5rem;">
                <button type="submit" class="btn btn-primary">Filtrar</button>
                {% if request.GET.buscar or request.GET.categoria or request.GET.estado %}
                <a href="{% url 'produccion:lista_productos' %}" class="btn btn-secondary">Limpiar</a>
                {% endif %}
            </div>
        </div>
    </form>
</div>

<!-- Tabla de Productos -->
<div class="tabla-productos">
    <table>
        <thead>
            <tr>
                <th style="width: 50px;">#</th>
                <th>
                    <a href="?orden=nombre{% if request.GET.categoria %}&categoria={{ request.GET.categoria }}{% endif %}" class="ordenar-link">
                        Producto
                        {% if request.GET.orden == 'nombre' %}‚Üì{% else %}‚Üï{% endif %}
                    </a>
                </th>
                <th style="width: 150px;">Categor√≠a</th>
                <th style="width: 120px; text-align: center;">Stock</th>
                <th style="width: 120px; text-align: right;">
                    <a href="?orden=precio_compra" class="ordenar-link">
                        P. Compra
                        {% if request.GET.orden == 'precio_compra' %}‚Üì{% else %}‚Üï{% endif %}
                    </a>
                </th>
                <th style="width: 120px; text-align: right;">
                    <a href="?orden=precio_venta" class="ordenar-link">
                        P. Venta
                        {% if request.GET.orden == 'precio_venta' %}‚Üì{% else %}‚Üï{% endif %}
                    </a>
                </th>
                <th style="width: 100px; text-align: right;">Ganancia</th>
                <th style="width: 100px; text-align: right;">Margen</th>
                <th style="width: 100px; text-align: center;">Estado</th>
                <th style="width: 150px; text-align: center;">Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for producto in productos %}
            <tr>
                <!-- N√∫mero -->
                <td style="color: #64748b; font-weight: 600;">
                    {{ forloop.counter }}
                </td>
                
                <!-- Producto -->
                <td>
                    <div class="producto-info">
                        <div class="producto-imagen-mini">
                            {% if producto.imagen %}
                                <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}">
                            {% else %}
                                üì¶
                            {% endif %}
                        </div>
                        <div class="producto-detalles">
                            <h3>{{ producto.nombre|slice:"2:" }}</h3>
                            <div class="producto-codigo">
                                {{ producto.codigo }} | #{{ producto.codigo_producto }}
                            </div>
                        </div>
                    </div>
                </td>
                
                <!-- Categor√≠a -->
                <td style="color: #64748b;">
                    {{ producto.categoria.nombre|default:"Sin categor√≠a" }}
                </td>
                
                <!-- Stock -->
                <td>
                    <div class="stock-cell">
                        <div class="stock-dot {% if producto.stock > producto.stock_minimo %}dot-verde{% elif producto.stock > 0 %}dot-amarillo{% else %}dot-rojo{% endif %}"></div>
                        <span class="stock-valor {% if producto.stock > producto.stock_minimo %}stock-alto{% elif producto.stock > 0 %}stock-medio{% else %}stock-bajo{% endif %}">
                            {{ producto.stock }}
                        </span>
                        <span style="font-size: 0.8rem; color: #94a3b8;">
                            {% if producto.stock <= producto.stock_minimo and producto.stock > 0 %}
                                (M√≠n: {{ producto.stock_minimo }})
                            {% elif producto.stock == 0 %}
                                (Sin stock)
                            {% endif %}
                        </span>
                    </div>
                </td>
                
                <!-- Precio Compra -->
                <td class="precio-cell precio-compra">
                    ${{ producto.precio_compra|floatformat:2 }}
                </td>
                
                <!-- Precio Venta -->
                <td class="precio-cell precio-venta">
                    ${{ producto.precio_venta|floatformat:2 }}
                </td>
                
                <!-- Ganancia -->
                <td class="precio-cell precio-ganancia">
                    ${{ producto.ganancia|floatformat:2 }}
                </td>
                
                <!-- Margen -->
                <td class="precio-cell" style="color: #667eea;">
                    {{ producto.margen|floatformat:1 }}%
                </td>
                
                <!-- Estado -->
                <td style="text-align: center;">
                    <span class="badge {% if producto.activo %}badge-activo{% else %}badge-inactivo{% endif %}">
                        {% if producto.activo %}‚úì Activo{% else %}‚úó Inactivo{% endif %}
                    </span>
                </td>
                
                <!-- Acciones -->
                <td class="acciones-cell">
                    <a href="{% url 'produccion:editar' producto.id %}" 
                       class="btn-tabla btn-editar" title="Editar">
                        ‚úèÔ∏è Editar
                    </a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="10" class="tabla-vacia">
                    <div class="tabla-vacia-icon">üì¶</div>
                    <h3 style="color: #64748b; font-size: 1.5rem; margin-bottom: 0.5rem;">
                        No hay productos
                    </h3>
                    <p style="color: #94a3b8; margin-bottom: 1.5rem;">
                        {% if request.GET.buscar or request.GET.categoria or request.GET.estado %}
                            No se encontraron productos con los filtros aplicados
                        {% else %}
                            Comienza agregando tu primer producto de producci√≥n
                        {% endif %}
                    </p>
                    {% if request.GET.buscar or request.GET.categoria or request.GET.estado %}
                    <a href="{% url 'produccion:lista_productos' %}" class="btn btn-secondary">
                        Limpiar Filtros
                    </a>
                    {% else %}
                    <a href="/admin/produccion/producto/add/" class="btn btn-primary">
                        ‚ûï Agregar Producto
                    </a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
        
        <!-- Totales -->
        {% if productos %}
        <tfoot style="background: #f8fafc; font-weight: 700;">
            <tr>
                <td colspan="3" style="padding: 1.25rem; text-align: right;">
                    TOTALES:
                </td>
                <td style="text-align: center; color: #667eea; font-size: 1.1rem;">
                    {{ stock_total }}
                </td>
                <td colspan="6"></td>
            </tr>
        </tfoot>
        {% endif %}
    </table>
</div>

<!-- Informaci√≥n adicional -->
{% if productos %}
<div style="margin-top: 1.5rem; padding: 1rem; background: white; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
    <div style="color: #64748b;">
        Mostrando <strong style="color: #1e293b;">{{ productos|length }}</strong> productos
    </div>
    <div style="font-size: 0.9rem; color: #94a3b8;">
        √öltima actualizaci√≥n: {{ productos.0.fecha_actualizacion|date:"d/m/Y H:i" }}
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
    // Confirmar acciones
    document.querySelectorAll('.btn-eliminar').forEach(btn => {
        btn.addEventListener('click', function(e) {
            if (!confirm('¬øEst√°s seguro de eliminar este producto?')) {
                e.preventDefault();
            }
        });
    });
    
    // Resaltar fila al hacer hover
    const filas = document.querySelectorAll('.tabla-productos tbody tr');
    filas.forEach(fila => {
        fila.addEventListener('click', function() {
            console.log('Producto seleccionado');
        });
    });
</script>
{% endblock %}